name: Auto Merge to Production

on:
  workflow_run:
    workflows: ["Validate Staging Environment"]
    types:
      - completed
    branches: [staging]

permissions:
  contents: write

jobs:
  auto-merge-production:
    name: Merge staging â†’ main (if validation passed)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge staging to main
        run: |
          echo "âœ… ValidaÃ§Ã£o staging passou! Mergeando staging â†’ main (production)..."
          git fetch origin
          
          # Checkout main
          git checkout main
          git pull origin main
          
          # Merge staging em main
          git merge origin/staging --no-ff -m "chore: auto-merge staging into main after validation passed

          âœ… All validations passed:
          - Integration tests âœ…
          - Smoke tests âœ…
          - Coverage verified âœ…
          
          Deploy to production will start automatically."
          
          # Push para main
          git push origin main
          
          echo "âœ… Staging mergeada em main (production) com sucesso!"
          echo "ğŸš€ Deploy production serÃ¡ iniciado automaticamente"

      - name: Notify Success
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… MERGE PARA PRODUÃ‡ÃƒO CONCLUÃDO!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ staging â†’ main (merged)"
          echo "ğŸš€ Deploy production iniciando..."
          echo "â±ï¸  Zero downtime deploy"
          echo "ğŸ¥ Health checks serÃ£o executados"
          echo "ğŸ“Œ Release tag serÃ¡ criada"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Notify Failure
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ FALHA NO MERGE PARA PRODUÃ‡ÃƒO!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸ PossÃ­vel conflito entre staging e main"
          echo "ğŸ”§ ResoluÃ§Ã£o manual necessÃ¡ria"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
      - name: Create Issue on Conflict
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ CRÃTICO: Falha no Merge AutomÃ¡tico staging â†’ main (production)',
              body: `## âŒ Merge AutomÃ¡tico para PRODUÃ‡ÃƒO Falhou
              
              **âš ï¸ ATENÃ‡ÃƒO: Deploy em produÃ§Ã£o foi bloqueado!**
              
              **Branch origem:** staging
              **Branch destino:** main (production)
              **Workflow:** [${context.workflow}](${context.payload.repository.html_url}/actions/runs/${context.runId})
              **Commit:** ${context.sha.substring(0, 7)}
              
              ### âœ… ValidaÃ§Ã£o Passou
              Todos os testes em staging passaram, mas o merge automÃ¡tico falhou (provavelmente conflito).
              
              ### ğŸ” AÃ§Ã£o URGENTE necessÃ¡ria:
              Resolver conflito manualmente:
              
              \`\`\`bash
              # 1. Checkout main
              git checkout main
              git pull origin main
              
              # 2. Merge staging
              git merge origin/staging
              
              # 3. Resolver conflitos (se houver)
              git status
              # Editar arquivos em conflito
              git add .
              git commit -m "fix: resolver conflitos staging â†’ main"
              
              # 4. Push (vai disparar deploy production)
              git push origin main
              \`\`\`
              
              ### ğŸ“‹ Verificar diferenÃ§as:
              \`\`\`bash
              git diff main..staging
              \`\`\`
              
              ### âš ï¸ ApÃ³s resolver:
              - Deploy production serÃ¡ iniciado automaticamente
              - Monitore health checks
              - Verifique se produÃ§Ã£o estÃ¡ OK
              `,
              labels: ['critical', 'merge-conflict', 'production-blocked', 'urgent'],
              assignees: ['${context.actor}']
            })
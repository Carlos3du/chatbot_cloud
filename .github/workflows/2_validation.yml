name: Validation & Merge Staging 

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [staging]

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  validate-and-merge:
    name: Validate and Auto-merge
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.ref == 'dev'
    
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install UV
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies with UV
        run: uv sync --frozen

      - name: Run Ruff Linter
        run: |
          echo "üîç Executando Ruff Linter..."
          uv run ruff check .

      - name: Run CI Tests
        env:
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "üß™ Executando testes de CI..."
          uv run pytest tests/ci/ -v

      - name: Build Docker Image
        run: |
          echo "üê≥ Construindo imagem Docker..."
          docker build -t chatbot-cloud:staging .

      - name: Verify Docker Build
        run: |
          echo "‚úÖ Verificando build Docker..."
          docker images chatbot-cloud:staging

      - name: Auto-merge PR
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üéâ Todos os testes passaram! Fazendo merge autom√°tico..."
          gh pr merge ${{ github.event.pull_request.number }} \
            --merge \
            --auto \
            --subject "‚úÖ Auto-merge: Dev -> Staging (validado automaticamente)"

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ Validation Pipeline conclu√≠do com sucesso!"
          echo "üîÄ Merge autom√°tico realizado: dev -> staging"
          echo "üì¶ Todos os testes passaram"
          echo "üê≥ Build Docker verificado"

      - name: Notify Failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "‚ùå **Valida√ß√£o Falhou**
            
            A valida√ß√£o autom√°tica falhou. O merge n√£o ser√° realizado at√© que os problemas sejam corrigidos.
            
            **A√ß√µes necess√°rias:**
            - Verifique os erros nos testes no workflow
            - Corrija os problemas identificados na branch dev
            - Push das corre√ß√µes acionar√° nova valida√ß√£o autom√°tica"
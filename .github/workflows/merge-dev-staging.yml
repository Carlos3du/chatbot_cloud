name: Auto Merge to Staging

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: ["dev"]

permissions:
  contents: write

jobs:
  auto-merge:
    name: Merge dev â†’ staging (if CI passed)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge dev to staging
        run: |
          echo "âœ… CI passou! Mergeando dev â†’ staging..."
          git fetch origin
          
          # Checkout staging
          git checkout staging
          git pull origin staging
          
          # Merge dev em staging
          git merge origin/dev --no-ff -m "chore: auto-merge dev into staging after CI passed"
          
          # Push para staging
          git push origin staging
          
          echo "âœ… Dev mergeada em staging com sucesso!"
          echo "ğŸš€ Deploy staging serÃ¡ iniciado automaticamente"

      - name: Notify Success
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… MERGE AUTOMÃTICO CONCLUÃDO!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ dev â†’ staging (merged)"
          echo "ğŸš€ Deploy staging iniciando..."
          echo "ğŸ§ª ValidaÃ§Ã£o serÃ¡ executada apÃ³s deploy"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Notify Failure
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ FALHA NO MERGE AUTOMÃTICO!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸ PossÃ­vel conflito entre dev e staging"
          echo "ğŸ”§ ResoluÃ§Ã£o manual necessÃ¡ria"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
      - name: Create Issue on Conflict
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Conflito no Merge AutomÃ¡tico: dev â†’ staging',
              body: `## âŒ Merge AutomÃ¡tico Falhou
              
              **Branch origem:** dev
              **Branch destino:** staging
              **Workflow:** [${context.workflow}](${context.payload.repository.html_url}/actions/runs/${context.runId})
              **Commit:** ${context.sha.substring(0, 7)}
              
              ### âœ… CI Pipeline Passou
              Todos os testes passaram, mas o merge automÃ¡tico falhou (provavelmente conflito).
              
              ### ğŸ” AÃ§Ã£o necessÃ¡ria:
              Resolver conflito manualmente:
              
              \`\`\`bash
              # 1. Checkout staging
              git checkout staging
              git pull origin staging
              
              # 2. Merge dev
              git merge origin/dev
              
              # 3. Resolver conflitos (se houver)
              git status
              # Editar arquivos em conflito
              git add .
              git commit -m "fix: resolver conflitos dev â†’ staging"
              
              # 4. Push
              git push origin staging
              \`\`\`
              
              ### ğŸ“‹ Arquivos que podem ter conflito:
              Execute \`git diff staging..dev\` para ver diferenÃ§as.
              `,
              labels: ['merge-conflict', 'staging', 'ci-passed', 'urgent'],
              assignees: ['${context.actor}']
            })
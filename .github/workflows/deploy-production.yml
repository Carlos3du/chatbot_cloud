name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  pre-deploy-validation:
    name: Pre-Deploy Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install UV
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies with UV
        run: uv sync --frozen

      - name: Run Integration Tests
        env:
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "ğŸ§ª Executando testes de integraÃ§Ã£o antes do deploy..."
          uv run pytest tests/integration/ -v --tb=short

      - name: Verify Docker Build
        run: |
          echo "ğŸ³ Verificando build do Docker..."
          docker build -t chatbot-cloud:production .

  deploy-production:
    name: Deploy to Railway Production (Zero Downtime)
    needs: pre-deploy-validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Deploy to Railway Production
        uses: bervProject/railway-deploy@main
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: ${{ secrets.RAILWAY_SERVICE_PRODUCTION }}
        
      - name: Wait for deployment stabilization
        run: |
          echo "â³ Aguardando deployment estabilizar (zero downtime)..."
          echo "ğŸ”„ Railway faz rolling deployment automaticamente"
          sleep 45

      - name: Health Check Production (Zero Downtime Verification)
        env:
          PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}
        run: |
          echo "ğŸ¥ Verificando health do serviÃ§o em produÃ§Ã£o..."
          echo "âš¡ Zero downtime: aplicaÃ§Ã£o deve estar respondendo"
          
          max_attempts=15
          attempt=1
          success_count=0
          required_successes=3  # Precisa passar 3 vezes seguidas
          
          while [ $attempt -le $max_attempts ]; do
            response=$(curl -s -o /dev/null -w "%{http_code}" ${PRODUCTION_URL}/health || echo "000")
            
            if [ "$response" = "200" ]; then
              success_count=$((success_count + 1))
              echo "âœ… Health check OK! (tentativa $attempt/$max_attempts - sucessos: $success_count/$required_successes)"
              
              if [ $success_count -ge $required_successes ]; then
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "âœ… PRODUÃ‡ÃƒO ESTÃVEL E SAUDÃVEL!"
                echo "âš¡ Zero downtime confirmado"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                exit 0
              fi
            else
              success_count=0  # Reset contador se falhar
              echo "â³ Aguardando estabilizaÃ§Ã£o... (tentativa $attempt/$max_attempts - cÃ³digo: $response)"
            fi
            
            sleep 5
            attempt=$((attempt + 1))
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ PRODUÃ‡ÃƒO NÃƒO ESTABILIZOU!"
          echo "âš ï¸ PossÃ­vel downtime detectado"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1

      - name: Smoke Test Production
        env:
          PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "ğŸ’¨ Executando smoke tests em produÃ§Ã£o..."
          
          # Test 1: Health
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¥ Testando /health..."
          health_response=$(curl -s -o /dev/null -w "%{http_code}" ${PRODUCTION_URL}/health)
          if [ "$health_response" = "200" ]; then
            echo "âœ… Health endpoint OK"
          else
            echo "âŒ Health endpoint falhou: $health_response"
            exit 1
          fi
          
          # Test 2: Chat
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ’¬ Testando /chat..."
          chat_response=$(curl -s -X POST ${PRODUCTION_URL}/chat \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${API_KEY}" \
            -d '{"message":"production smoke test"}' \
            -w "\n%{http_code}")
          
          http_code=$(echo "$chat_response" | tail -n1)
          response_body=$(echo "$chat_response" | head -n-1)
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Chat endpoint OK"
            echo "ğŸ“ Resposta: $response_body"
          else
            echo "âŒ Chat endpoint falhou: $http_code"
            echo "ğŸ“ Resposta: $response_body"
            exit 1
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Todos os smoke tests passaram!"

      - name: Create Release Tag
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          VERSION=$(date +"%Y.%m.%d-%H%M")
          git tag -a "v${VERSION}" -m "Production release v${VERSION}
          
          âœ… Zero downtime deploy
          âœ… Health checks passed
          âœ… Smoke tests passed"
          
          git push origin "v${VERSION}" || echo "Tag jÃ¡ existe"
          
          echo "âœ… Tag de release criada: v${VERSION}"

      - name: Notify Success
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ DEPLOY EM PRODUÃ‡ÃƒO CONCLUÃDO!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Zero downtime deploy"
          echo "âœ… Health checks passaram"
          echo "âœ… Smoke tests passaram"
          echo "ğŸ“Œ Tag de release criada"
          echo "ğŸ”— AplicaÃ§Ã£o: ${{ secrets.PRODUCTION_URL }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Rollback on Failure
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš¨ DEPLOY FALHOU - INICIANDO ROLLBACK"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸ AÃ‡ÃƒO MANUAL NECESSÃRIA:"
          echo "1. Verificar Railway Dashboard"
          echo "2. Fazer rollback manual se necessÃ¡rio"
          echo "3. Ou executar: git revert HEAD && git push"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ CRÃTICO: Falha no Deploy de PRODUÃ‡ÃƒO',
              body: `## âŒ Deploy em ProduÃ§Ã£o FALHOU
              
              **âš ï¸ ATENÃ‡ÃƒO: Ambiente de produÃ§Ã£o pode estar comprometido!**
              
              **Branch:** main (production)
              **Commit:** ${context.sha.substring(0, 7)}
              **Workflow:** [${context.workflow}](${context.payload.repository.html_url}/actions/runs/${context.runId})
              
              ### ğŸš¨ AÃ§Ãµes URGENTES:
              1. âœ… Verificar logs do workflow
              2. âœ… Checar Railway Dashboard
              3. âœ… Testar endpoint: ${process.env.PRODUCTION_URL}/health
              4. âœ… Considerar rollback imediato
              
              ### ğŸ”™ Rollback RÃ¡pido:
              \`\`\`bash
              # OpÃ§Ã£o 1: Revert Ãºltimo commit
              git checkout main
              git revert HEAD
              git push origin main
              
              # OpÃ§Ã£o 2: Reset para versÃ£o anterior
              git checkout main
              git reset --hard HEAD~1
              git push --force origin main
              
              # OpÃ§Ã£o 3: Railway Dashboard
              # Fazer rollback manual no Railway
              \`\`\`
              
              ### ğŸ“Š Health Check:
              \`\`\`bash
              curl ${process.env.PRODUCTION_URL}/health
              curl -X POST ${process.env.PRODUCTION_URL}/chat \\
                -H "Content-Type: application/json" \\
                -H "X-API-Key: ${process.env.API_KEY}" \\
                -d '{"message":"test"}'
              \`\`\`
              `,
              labels: ['critical', 'production', 'deployment-failed', 'urgent'],
              assignees: ['${context.actor}']
            })
name: Validate Staging Environment

on:
  workflow_run:
    workflows: ["Deploy to Staging"]
    types: [completed]
    branches: [staging]

permissions:
  contents: read
  issues: write

jobs:
  integration-tests:
    name: Run Integration Tests
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout staging branch
        uses: actions/checkout@v4
        with:
          ref: staging

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install UV
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies with UV
        run: uv sync --frozen

      - name: Run Integration Tests with TestClient
        env:
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "üß™ Executando testes de integra√ß√£o com TestClient..."
          uv run pytest tests/integration/ -v --tb=short --cov=app --cov-report=term-missing

      - name: Smoke Test on Real Staging (Optional)
        if: success()
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}
        run: |
          echo "üí® Smoke test r√°pido no ambiente real..."
          curl -f ${STAGING_URL}/health || echo "‚ö†Ô∏è Staging URL n√£o respondeu"

      - name: Generate Coverage Report
        if: always()
        run: |
          echo "üìä Relat√≥rio de Cobertura:"
          uv run coverage report

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ Todas as valida√ß√µes passaram!"
          echo "üöÄ C√≥digo validado e pronto para produ√ß√£o"

      - name: Notify Failure
        if: failure()
        run: |
          echo "‚ùå Valida√ß√£o FALHOU!"
          echo "üîß Verifique os logs acima"

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Falha nos Testes de Integra√ß√£o - Staging',
              body: `## ‚ùå Testes de Integra√ß√£o Falharam
              
              **Branch:** staging
              **Workflow:** ${context.workflow}
              **Run:** [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})
              
              ### üîç A√ß√µes necess√°rias:
              1. Verificar logs do workflow
              2. Executar testes localmente: \`uv run pytest tests/integration/ -v\`
              3. Corrigir problemas identificados
              4. Fazer commit e push para staging
              
              ### üìã Comandos √∫teis:
              \`\`\`bash
              # Rodar testes localmente
              export API_KEY="your-key"
              uv sync
              uv run pytest tests/integration/ -v --tb=short
              \`\`\`
              `,
              labels: ['bug', 'staging', 'integration-tests', 'ci-failed']
            })
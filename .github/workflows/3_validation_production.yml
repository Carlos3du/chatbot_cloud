name: Validation & Production Merge

on:
  # 1. Permite que este workflow seja chamado por outro (o Deploy)
  workflow_call:
    # Se precisar de inputs espec√≠ficos, define-se aqui.
    # Segredos s√£o herdados automaticamente se usar 'secrets: inherit' no chamador.

  # 2. Permite rodar manualmente para testes
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  validation:
    name: Integration and Functional Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Staging Code
        uses: actions/checkout@v4
        with:
          # Garante que estamos validando a branch staging
          ref: staging
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"
      
      - name: Install dependencies
        run: uv sync --frozen
      
      - name: Run integration tests
        env:
          # Estes secrets v√™m do workflow 'Deploy Staging' via (secrets: inherit)
          STAGING_URL: ${{ secrets.STAGING_URL }}
          RAILWAY_SERVICE_STAGING: ${{ secrets.RAILWAY_SERVICE_STAGING }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "üß™ Iniciando testes de integra√ß√£o..."
          uv run pytest tests/integration -v

      # --- LOGIN DOCKER (Necess√°rio antes do build/push) ---
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

       # --- BUILD DA IMAGEM ---
      - name: Build Docker Image
        # Define o nome completo da imagem (usuario/repo:tag)
        run: |
          echo "üê≥ Construindo imagem Docker..."
          docker build -t ${{ secrets.DOCKER_USERNAME }}/chatbot-cloud:production .

      # --- SMOKE TEST (Testa a imagem localmente antes de subir) ---
      - name: Smoke Test Docker Image
        env:
          API_KEY: ${{ secrets.API_KEY }}
          # Armazena o nome da imagem numa vari√°vel para facilitar
          IMAGE_TAG: ${{ secrets.DOCKER_USERNAME }}/chatbot-cloud:production
        run: |
          echo "üî• Iniciando Smoke Test do container..."
          docker run -d --name production-smoke \
            -e API_KEY=$API_KEY \
            -p 8000:8000 \
            $IMAGE_TAG
          
          echo "‚è≥ Aguardando inicializa√ß√£o (10s)..."
          sleep 10
          
          if [ "$(docker inspect -f '{{.State.Running}}' production-smoke)" = "true" ]; then
            echo "‚úÖ Container est√° rodando e saud√°vel!"
            docker logs production-smoke
            docker rm -f production-smoke
          else
            echo "‚ùå CR√çTICO: Container falhou ao iniciar. Abortando deploy e merge."
            docker logs production-smoke
            exit 1
          fi

      # --- PUSH PARA DOCKER HUB (S√≥ roda se o Smoke Test passar) ---
      - name: Push Image to Docker Hub
        run: |
          echo "üöÄ Smoke Test aprovado. Enviando imagem para Docker Hub..."
          docker push ${{ secrets.DOCKER_USERNAME }}/chatbot-cloud:production

  create-production-pr:
    name: Create PR to Main
    needs: validation
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout Staging Code
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0
      
      - name: Create Pull Request (Staging -> Main)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üöÄ Testes de integra√ß√£o passaram. Criando PR para Produ√ß√£o..."
          gh pr create \
            --base main \
            --head staging \
            --title "üöÄ Auto PR: Staging -> Main (Deploy Validado)" \
            --body "## üö¢ Merge to Production
            
            ‚úÖ **Ciclo de Valida√ß√£o de Staging Completo**
            
            Este PR foi gerado automaticamente pelo pipeline.
            - Testes de Integra√ß√£o: OK
            - Deploy Staging: OK" \
            --assignee ${{ github.actor }} \
            || echo "‚ö†Ô∏è Aviso: PR j√° existe."
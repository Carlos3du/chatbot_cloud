name: Validation & Production Merge

on:
  # 1. Permite que este workflow seja chamado por outro (o Deploy)
  workflow_call:
    # Se precisar de inputs espec√≠ficos, define-se aqui.
    # Segredos s√£o herdados automaticamente se usar 'secrets: inherit' no chamador.

  # 2. Permite rodar manualmente para testes
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  validation:
    name: Integration and Functional Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Staging Code
        uses: actions/checkout@v4
        with:
          # Garante que estamos validando a branch staging
          ref: staging
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"
      
      - name: Install dependencies
        run: uv sync --frozen
      
      - name: Run integration tests
        env:
          # Estes secrets v√™m do workflow 'Deploy Staging' via (secrets: inherit)
          STAGING_URL: ${{ secrets.STAGING_URL }}
          RAILWAY_SERVICE_STAGING: ${{ secrets.RAILWAY_SERVICE_STAGING }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "üß™ Iniciando testes de integra√ß√£o..."
          uv run pytest tests/integration -v


  create-production-pr:
    name: Create PR to Main
    needs: validation
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout Staging Code
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0
      
      - name: Create Pull Request (Staging -> Main)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üöÄ Testes de integra√ß√£o passaram. Criando PR para Produ√ß√£o..."
          gh pr create \
            --base main \
            --head staging \
            --title "üöÄ Auto PR: Staging -> Main (Deploy Validado)" \
            --body "## üö¢ Merge to Production
            
            ‚úÖ **Ciclo de Valida√ß√£o de Staging Completo**
            
            Este PR foi gerado automaticamente pelo pipeline.
            - Testes de Integra√ß√£o: OK
            - Deploy Staging: OK" \
            --assignee ${{ github.actor }} \
            || echo "‚ö†Ô∏è Aviso: PR j√° existe."
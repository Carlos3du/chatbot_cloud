name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  pre-deploy-validation:
    name: Pre-Deploy Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install UV
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies with UV
        run: uv sync --frozen

      - name: Run Integration Tests
        env:
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "üß™ Executando testes de integra√ß√£o antes do deploy..."
          uv run pytest tests/integration/ -v --tb=short

      - name: Verify Docker Build
        run: |
          echo "üê≥ Verificando build do Docker..."
          docker build -t chatbot-cloud:production .

  deploy-production:
    name: Deploy to Railway Production
    needs: pre-deploy-validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Deploy to Railway Production
        uses: bervProject/railway-deploy@main
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: ${{ secrets.RAILWAY_SERVICE_PRODUCTION }}
        
      - name: Wait for deployment
        run: |
          echo "‚è≥ Aguardando deployment estabilizar..."
          sleep 30

      - name: Health Check Production
        env:
          PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}
        run: |
          echo "üè• Verificando health do servi√ßo em produ√ß√£o..."
          
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            response=$(curl -s -o /dev/null -w "%{http_code}" ${PRODUCTION_URL}/health || echo "000")
            
            if [ "$response" = "200" ]; then
              echo "‚úÖ Produ√ß√£o est√° saud√°vel! (tentativa $attempt/$max_attempts)"
              exit 0
            fi
            
            echo "‚è≥ Aguardando... (tentativa $attempt/$max_attempts)"
            sleep 10
            attempt=$((attempt + 1))
          done
          
          echo "‚ùå Produ√ß√£o n√£o respondeu ap√≥s $max_attempts tentativas!"
          exit 1

      - name: Create Release Tag
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          VERSION=$(date +"%Y.%m.%d-%H%M")
          git tag -a "v${VERSION}" -m "Production release v${VERSION}"
          git push origin "v${VERSION}" || echo "Tag j√° existe"
          
          echo "‚úÖ Tag de release criada: v${VERSION}"

      - name: Notify Success
        if: success()
        run: |
          echo "üéâ Deploy em PRODU√á√ÉO conclu√≠do com sucesso!"
          echo "‚úÖ Health check passou"
          echo "üìå Tag de release criada"
          echo "üîó Aplica√ß√£o: ${{ secrets.PRODUCTION_URL }}"

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® CR√çTICO: Falha no Deploy de PRODU√á√ÉO',
              body: `## ‚ùå Deploy em Produ√ß√£o FALHOU
              
              **Branch:** main (production)
              **Commit:** ${context.sha.substring(0, 7)}
              **Workflow:** [${context.workflow}](${context.payload.repository.html_url}/actions/runs/${context.runId})
              
              ### üö® A√ß√µes URGENTES:
              1. Verificar logs do workflow
              2. Checar Railway Dashboard
              3. Considerar rollback
              
              ### üîô Rollback:
              \`\`\`bash
              git revert ${context.sha}
              git push origin main
              \`\`\`
              `,
              labels: ['critical', 'production', 'deployment-failed'],
              assignees: ['${context.actor}']
            })
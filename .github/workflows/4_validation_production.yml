name: Validation & Production Merge

on:
  # O PULO DO GATO:
  # Este gatilho "escuta" o t√©rmino do workflow chamado "Deploy to Staging".
  # O nome em 'workflows' DEVE ser id√™ntico ao 'name:' do arquivo deploy_staging.yml
  workflow_run:
    workflows: ["Deploy to Staging"]
    branches: [staging]
    types:
      - completed

  # Mantemos o dispatch para voc√™ poder rodar manualmente se precisar testar
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  validation:
    name: Integration and Functional Tests
    runs-on: ubuntu-latest
    # IMPORTANTE: S√≥ roda se o Deploy de Staging foi SUCESSO.
    # Sem isso, ele rodaria mesmo se o deploy quebrasse.
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Garante que estamos pegando a vers√£o exata que acabou de ser deployada na staging
          ref: staging
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"
      
      - name: Install dependencies
        run: uv sync --frozen
      
      - name: Run integration tests
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}
          RAILWAY_SERVICE_STAGING: ${{ secrets.RAILWAY_SERVICE_STAGING }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          echo "üß™ Iniciando testes de integra√ß√£o contra Staging..."
          # O deploy acabou de acontecer, ent√£o estamos testando a vers√£o nova
          uv run pytest tests/integration -v

  create-production-pr:
    name: Create PR to Main
    needs: validation
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0
      
      - name: Create Pull Request (Staging -> Main)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üöÄ Testes de integra√ß√£o passaram. Criando PR para Produ√ß√£o..."
          gh pr create \
            --base main \
            --head staging \
            --title "üöÄ Auto PR: Staging -> Main (Deploy Validado)" \
            --body "## üö¢ Merge to Production (Main)
            
            ‚úÖ **Ciclo de Valida√ß√£o de Staging Completo**
            
            Este PR foi gerado automaticamente ap√≥s:
            1. Deploy autom√°tico em Staging (Sucesso)
            2. Testes de Integra√ß√£o na API rodando (Sucesso)
            
            ### üìä Resultados dos Testes
            - Integra√ß√£o: ‚úÖ Passou
            - Deploy Staging: ‚úÖ Est√°vel
            
            **Pr√≥ximo Passo:**
            - Revis√£o Humana Obrigat√≥ria
            - Merge para iniciar Deploy em Produ√ß√£o" \
            --assignee ${{ github.actor }} \
            || echo "‚ö†Ô∏è Aviso: Um PR de staging para main j√° existe ou n√£o h√° mudan√ßas. Nenhuma a√ß√£o necess√°ria."
      
  notify-failure:
    name: Notify Validation Failure
    needs: [validation]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: Send notification
        run: |
          echo "‚ùå FALHA CR√çTICA: A valida√ß√£o do ambiente de Staging falhou."
          echo "O Deploy para Produ√ß√£o foi cancelado/bloqueado."
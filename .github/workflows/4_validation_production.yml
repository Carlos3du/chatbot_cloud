name: Validation & Production Merge

on:
  workflow_run:
    workflows: ["Deploy to Staging"]
    types:
      - completed
    branches:
      - staging

jobs:
  validation:
    name: Integration and Functional Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
      
      - name: Install dependencies
        run: uv sync
      
      - name: Run integration tests
        run: uv run pytest tests/integration -v
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}
          RAILWAY_SERVICE_STAGING: ${{ secrets.RAILWAY_SERVICE_STAGING }}
      

  create-production-pr:
    name: Create PR to Main
    needs: validation
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: staging
      
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base main \
            --head staging \
            --title "üöÄ Merge to Main" \
            --body "## Merge to Main
            
            ‚úÖ All staging validation tests passed successfully
            
            ### Tests Results
            - Integration tests: ‚úÖ
            - Functional tests: ‚úÖ
            - Health check: ‚úÖ
            
            This PR is auto-generated after successful staging validation." \
            --assignee ${{ github.actor }} \
            || echo "‚ö†Ô∏è PR j√° existe ou n√£o h√° diferen√ßas"
      
      
  notify-failure:
    name: Notify Validation Failure
    needs: validation
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: Send notification
        run: |
          echo "‚ùå Staging validation failed. Production deploy cancelled."